# omnictl cluster template sync -v -f cluster-template-working.yaml
---
kind: Cluster
name: labber
labels:
  cluster-id: "1"
kubernetes:
  version: v1.35.0
talos:
  version: v1.12.2
patches:
  - name: disable-default-cni
    inline:
      cluster:
        network:
          cni:
            name: none
        proxy:
          disabled: true
---
kind: ControlPlane
machineClass:
  name: proxmox-control-plane
  size: 3
systemExtensions:
  - siderolabs/iscsi-tools
  - siderolabs/nfsd
  - siderolabs/qemu-guest-agent
  - siderolabs/util-linux-tools
patches:
  - file: iac/omni/cluster-template/patches/control-plane.yaml
---
kind: Workers
name: workers
machineClass:
  name: proxmox-worker
  size: 2
systemExtensions:
  - siderolabs/iscsi-tools
  - siderolabs/nfsd
  - siderolabs/qemu-guest-agent 
  - siderolabs/util-linux-tools
patches:
  - file: iac/omni/cluster-template/patches/worker.yaml
  - name: longhorn-storage
    inline:
      machine:
        kubelet:
          extraMounts:
            - destination: /var/lib/longhorn
              type: bind
              source: /var/local/longhorn
              options:
                - bind
                - rshared
                - rw
---
kind: Workers
name: gpu-workers
machineClass:
  name: proxmox-intel-gpu-worker
  size: 1
systemExtensions:
  - siderolabs/iscsi-tools
  - siderolabs/nfsd
  - siderolabs/qemu-guest-agent
  - siderolabs/util-linux-tools
  #- siderolabs/i915
  - siderolabs/intel-ucode
  - siderolabs/xe
patches:
  - name: gpu-worker-labels
    inline:
      machine:
        nodeLabels:
          gpu-worker: "true"
          intel.com/gpu: "true"
  - file: iac/omni/cluster-template/patches/intel-gpu-worker.yaml
  - name: longhorn-storage
    inline:
      machine:
        kubelet:
          extraMounts:
            - destination: /var/lib/longhorn
              type: bind
              source: /var/local/longhorn
              options:
                - bind
                - rshared
                - rw
### NVIDIA GPU CONFIG ###
#---
#kind: Workers
#name: gpu-workers
#machineClass:
#  name: proxmox-intel-gpu-worker
#  size: 1
#systemExtensions:
#  - siderolabs/iscsi-tools
#  - siderolabs/nfsd
#  - siderolabs/qemu-guest-agent
#  - siderolabs/util-linux-tools
#  - siderolabs/nonfree-kmod-nvidia-production
#  - siderolabs/nvidia-container-toolkit-production
#patches:
#  - file: iac/omni/cluster-template/patches/nvidia-gpu-worker.yaml
#  - name: longhorn-storage
#    inline:
#      machine:
#        kubelet:
#          extraMounts:
#            - destination: /var/lib/longhorn
#              type: bind
#              source: /var/local/longhorn
#              options:
#                - bind
#                - rshared
#                - rw